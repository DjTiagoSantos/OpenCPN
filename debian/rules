#!/usr/bin/make -f

include  /usr/share/dpkg/pkg-info.mk

# Enable hardening build flags
export DEB_BUILD_MAINT_OPTIONS=hardening=+all

LDFLAGS += -Wl,--as-needed
export LDFLAGS

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
	    -DCMAKE_LIBRARY_PATH=$(DEB_HOST_MULTIARCH) \
	    -DCMAKE_INSTALL_PREFIX=/usr \
	    -DBUNDLE_DOCS=OFF \
            -DBUNDLE_TCDATA=ON \
            -DBUNDLE_GSHHS=CRUDE \
            -DBUILD_SHARED_LIBS=OFF \
	    -DUSE_BUNDLED_LIBS=OFF

override_dh_auto_install:
	dh_auto_install --destdir=debian/tmp
	# Remove generated files without source.
	rm -rf debian/tmp/usr/share/opencpn/doc/opencpn
	rm debian/tmp/usr/share/opencpn/plugins/chartdldr_pi/data/doc/highlight.min.js
	rm debian/tmp/usr/share/opencpn/plugins/chartdldr_pi/data/doc/MathJax.js
	# Move plugin documentation to proper location
	-mv debian/tmp/usr/share/opencpn/sounds/README.bells \
	    debian/tmp/usr/share/opencpn/tcdata/README.harmonics \
	    debian/tmp/usr/share/opencpn/doc
	# Don't use the legacy appdata location
	mkdir debian/tmp/usr/share/metainfo
	-mv debian/tmp/usr/share/appdata/opencpn.appdata.xml \
	    debian/tmp/usr/share/metainfo
	# Don't install duplicate gplv2 license:
	# https://github.com/OpenCPN/OpenCPN/pull/1143
	rm -f debian/tmp/usr/share/opencpn/license.txt
	# Fix desktop file missing keywords and validate:
	desktop-file-edit \
	    --set-key=Keywords --set-value="gps;navigation;chart" \
	    ./debian/tmp/usr/share/applications/opencpn.desktop


override_dh_missing:
	dh_missing --fail-missing

# Work around what's seemingly a tar bug, see
# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=831870

VERSION     = $(word 1,$(subst +, ,$(DEB_VERSION_UPSTREAM)))

get-orig-source:
	rm -rf utmp; mkdir utmp
	uscan  --destdir=utmp  --force-download --safe
	cd utmp; \
	    tar xaf *-*.tar.*z; \
	    test -d OpenCPN-$(VERSION) || \
	        mv $$(find . -mindepth 1 -maxdepth 1 -type d) \
	           OpenCPN-$(VERSION); \
	    tar caf opencpn-$(VERSION).tar.gz OpenCPN-$(VERSION)
	mk-origtargz --compression gzip \
                     --repack \
	             utmp/opencpn-$(VERSION).tar.gz \
	    && rm -rf utmp
