From: Alec Leamas <leamas.alec@nowhere.net>
Date: Tue, 27 Dec 2022 13:39:09 +0100
Subject: [PATCH] tests: Handle different target when built from source

---
 libs/gtest/CMakeLists.txt | 13 ++++++-------
 test/CMakeLists.txt       |  2 ++
 2 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/libs/gtest/CMakeLists.txt b/libs/gtest/CMakeLists.txt
index 92fd8cb..f42d252 100644
--- a/libs/gtest/CMakeLists.txt
+++ b/libs/gtest/CMakeLists.txt
@@ -28,12 +28,13 @@ else ()
     NO_DEFAULT_PATH
   )
   include(FetchContent)
+  set(CMAKE_CXX_STANDARD 14)
+  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
+  set(BUILD_GMOCK OFF)
+  set(INSTALL_GTEST OFF)
   if (GTEST_SRC_LOCATION)
     message(STATUS "Building gtest from installed sources")
-    FetchContent_Declare(
-      googletest
-      URL ${GTEST_SRC_LOCATION}
-    )
+    add_subdirectory(${GTEST_SRC_LOCATION} ${CMAKE_BINARY_DIR}/gtest)
   else ()
     message(STATUS "Downloading and building gtest from source")
     FetchContent_Declare(
@@ -41,9 +42,7 @@ else ()
       GIT_REPOSITORY https://github.com/google/googletest.git
       GIT_TAG release-1.12.1
     )
+    FetchContent_MakeAvailable(googletest)
   endif ()
-  set(CMAKE_CXX_STANDARD 14)
-  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
-  FetchContent_MakeAvailable(googletest)
   target_link_libraries(_OCPN_GTEST_IF INTERFACE GTest::gtest_main)
 endif ()
diff --git a/test/CMakeLists.txt b/test/CMakeLists.txt
index c70e639..765839c 100644
--- a/test/CMakeLists.txt
+++ b/test/CMakeLists.txt
@@ -8,6 +8,8 @@ message(STATUS "Building tests")
 
 enable_testing ()
 
+
+
 set(PROJ_SRC ${PROJECT_SOURCE_DIR}/../src)
 
 set(SRC
