From: Alec Leamas <leamas.alec@gmail.com>
Date: Tue, 28 Sep 2021 09:35:26 +0200
Subject: Finalize refactoring of ser_ports/chart1

Forwarded: https://github.com/OpenCPN/OpenCPN/pull/2402

---
 src/chart1.cpp    | 80 -------------------------------------------------------
 src/ser_ports.cpp | 49 +++++++++++++++++++++++++++++-----
 2 files changed, 42 insertions(+), 87 deletions(-)

diff --git a/src/chart1.cpp b/src/chart1.cpp
index 1fff029..8f15f2f 100644
--- a/src/chart1.cpp
+++ b/src/chart1.cpp
@@ -9979,86 +9979,6 @@ void MyPrintout::GenerateGLbmp() {
 //
 //---------------------------------------------------------------------------------------
 
-/*
- *     Enumerate all the serial ports on the system
- *
- *     wxArrayString *EnumerateSerialPorts(void)
-
- *     Very system specific, unavoidably.
- */
-
-#if (__UNIX__) && !defined(__OCPN__ANDROID__) && !defined(__WXOSX__)
-extern "C" int wait(int *);  // POSIX wait() for process
-
-#include <termios.h>
-#include <sys/ioctl.h>
-#ifdef __linux__
-#include <linux/serial.h>
-#endif
-
-#endif
-
-// ****************************************
-// Fulup devices selection with scandir
-// ****************************************
-
-// reserve 4 pattern for plugins
-char *devPatern[] = {NULL, NULL, NULL, NULL,      NULL,
-                     NULL, NULL, NULL, (char *)-1};
-
-// This function allow external plugin to search for a special device name
-// ------------------------------------------------------------------------
-int paternAdd(const char *patern) {
-  int ind;
-
-  // snan table for a free slot inside devpatern table
-  for (ind = 0; devPatern[ind] != (char *)-1; ind++)
-    if (devPatern[ind] == NULL) break;
-
-  // table if full
-  if (devPatern[ind] == (char *)-1) return -1;
-
-  // store a copy of the patern in case calling routine had it on its stack
-  devPatern[ind] = strdup(patern);
-  return 0;
-}
-
-#if defined(__UNIX__) && !defined(__OCPN__ANDROID__) && !defined(__WXOSX__)
-// This filter verify is device is withing searched patern and verify it is
-// openable
-// -----------------------------------------------------------------------------------
-int paternFilter(const struct dirent *dir) {
-  char *res = NULL;
-  char devname[272];
-  int fd, ind;
-
-  // search if devname fits with searched paterns
-  for (ind = 0; devPatern[ind] != (char *)-1; ind++) {
-    if (devPatern[ind] != NULL)
-      res = (char *)strcasestr(dir->d_name, devPatern[ind]);
-    if (res != NULL) break;
-  }
-
-  // File does not fit researched patern
-  if (res == NULL) return 0;
-
-  // Check if we may open this file
-  snprintf(devname, sizeof(devname), "/dev/%s", dir->d_name);
-  fd = open(devname, O_RDWR | O_NDELAY | O_NOCTTY);
-
-  // device name is pointing to a real device
-  if (fd >= 0) {
-    close(fd);
-    return 1;
-  }
-
-  // file is not valid
-  perror(devname);
-  return 0;
-}
-
-#endif
-
 /*************************************************************************
  * Global color management routines
  *
diff --git a/src/ser_ports.cpp b/src/ser_ports.cpp
index beaf2d0..8c59d58 100644
--- a/src/ser_ports.cpp
+++ b/src/ser_ports.cpp
@@ -81,6 +81,12 @@
 #include <unistd.h>
 #endif
 
+#ifdef __linux__
+#include <termios.h>
+#include <linux/serial.h>
+#endif
+
+
 #ifdef __WXMSW__
 #include <windows.h>
 #include <setupapi.h>
@@ -517,6 +523,35 @@ wxArrayString* EnumerateSerialPorts(void) {
 
 #else  // Linux...
 
+
+int paternFilter(const struct dirent *dir) {
+  static const std::vector<std::string> devPatern = {
+      "ttyUSB", "ttyACM", "ttyGPS", "refcom"
+  };
+
+  bool found = false;
+  const std::string device(dir->d_name);
+  for (auto patern : devPatern) {
+    if (device.find(patern) != std::string::npos) {
+      found = true;
+      break;
+    }
+  }
+  if (!found) return 0;
+
+  auto path = std::string("/dev/") + device;
+  int fd = open(path.c_str(), O_RDWR | O_NDELAY | O_NOCTTY);
+  if (fd >= 0) {
+    // device name is pointing to a real device
+    close(fd);
+    return 1;
+  }
+
+  // file is not valid
+  wxLogDebug("Cannot open device %s: %s", path.c_str(), strerror(fd));
+  return 0;
+}
+
 wxArrayString* EnumerateSerialPorts(void) {
   wxArrayString* preturn = new wxArrayString;
 #ifdef OCPN_USE_NEWSERIAL
@@ -532,14 +567,14 @@ wxArrayString* EnumerateSerialPorts(void) {
   }
 
 #else  // OPCN_USE_NEWSERIAL
+/*
+ *     Enumerate all the serial ports on the system
+ *
+ *     wxArrayString *EnumerateSerialPorts(void)
+
+ *     Very system specific, unavoidably.
+ */
 
-  // Initialize the pattern table
-  if (devPatern[0] == NULL) {
-    paternAdd("ttyUSB");
-    paternAdd("ttyACM");
-    paternAdd("ttyGPS");
-    paternAdd("refcom");
-  }
 
   //  Looking for user privilege openable devices in /dev
   //  Fulup use scandir to improve user experience and support new generation of
