From: Alec Leamas <leamas.alec@gmail.com>
Date: Tue, 27 Dec 2022 20:35:34 +0100
Subject: sources, headers: Handle different serial lib header location.

---
 CMakeLists.txt                 | 1 +
 cmake/SystemLibs.cmake         | 4 ++--
 cmake/in-files/config.h.in     | 2 ++
 include/comm_drv_n2k_serial.h  | 5 ++++-
 src/comm_drv_n0183_serial.cpp  | 5 ++++-
 src/comm_drv_n2k_socketcan.cpp | 9 +++++++--
 src/ocpn_app.cpp               | 5 +++--
 src/ser_ports.cpp              | 4 +++-
 8 files changed, 26 insertions(+), 9 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 28f1882..82cd407 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1280,6 +1280,7 @@ endif ()
 # For OpenCPN, these include files and related methods are really only valid in complete linux/unix environments
 #  So, pending further information, we disable these tests for non-UNIX-like builds.
 if ( UNIX )
+  find_path(HAVE_SYS_SERIAL_LIB NAMES serial.h)
   find_path(HAVE_UNISTD_H NAMES unistd.h)
   find_path(HAVE_LIBGEN_H NAMES libgen.h)
   find_path(HAVE_DIRENT_H NAMES dirent.h)
diff --git a/cmake/SystemLibs.cmake b/cmake/SystemLibs.cmake
index c53b112..f70e10a 100644
--- a/cmake/SystemLibs.cmake
+++ b/cmake/SystemLibs.cmake
@@ -14,5 +14,5 @@ find_library(LibSerial cxx-serial REQUIRED)
 find_file(SerialHeader NAME serial.h  REQUIRED)
 target_link_libraries(SERIAL_IF INTERFACE ${LibSerial})
 add_library(ocpn::serial ALIAS SERIAL_IF)
-set(HAVE_SYS_SERIAL_LIB ON CACHE BOOL "")
-add_compile_definitions(HAVE_STDINT_H)   # For external libs missing config.h
+
+set(HAVE_STDINT_H ON) 
diff --git a/cmake/in-files/config.h.in b/cmake/in-files/config.h.in
index fb47468..83b5451 100644
--- a/cmake/in-files/config.h.in
+++ b/cmake/in-files/config.h.in
@@ -37,6 +37,7 @@
 #cmakedefine HAVE_PORTAUDIO
 #cmakedefine HAVE_READLINK
 #cmakedefine HAVE_SNDFILE
+#cmakedefine HAVE_STDINT_H
 #cmakedefine HAVE_SYSTEM_CMD_SOUND
 #cmakedefine HAVE_UNISTD_H
 #cmakedefine USE_SYSFS_PORTS
@@ -47,6 +48,7 @@
 #cmakedefine HAVE_SYS_IOCTL_H
 #cmakedefine HAVE_SYS_SERIAL_LIB
 
+
 // The os compatible plugins are are built for
 #define PKG_TARGET "${PKG_TARGET}"
 
diff --git a/include/comm_drv_n2k_serial.h b/include/comm_drv_n2k_serial.h
index acabcd7..4159b66 100644
--- a/include/comm_drv_n2k_serial.h
+++ b/include/comm_drv_n2k_serial.h
@@ -28,10 +28,13 @@
 
 #include <wx/thread.h>
 
+#include "config.h"
 #include "comm_drv_n2k.h"
 #include "conn_params.h"
 
-#ifndef __OCPN__ANDROID__
+#ifdef HAVE_SYS_SERIAL_LIB
+#include <serial.h>
+#elif !defined(__ANDROID__)
 #include "serial/serial.h"
 #endif
 
diff --git a/src/comm_drv_n0183_serial.cpp b/src/comm_drv_n0183_serial.cpp
index 513642a..005b27d 100644
--- a/src/comm_drv_n0183_serial.cpp
+++ b/src/comm_drv_n0183_serial.cpp
@@ -40,11 +40,14 @@
 #include <wx/string.h>
 #include <wx/utils.h>
 
+#include "config.h"
 #include "comm_drv_n0183_serial.h"
 #include "comm_navmsg_bus.h"
 #include "comm_drv_registry.h"
 
-#ifndef __ANDROID__
+#ifdef HAVE_SYS_SERIAL_LIB
+#include <serial.h>
+#elif !defined(__ANDROID__)
 #include "serial/serial.h"
 #endif
 
diff --git a/src/comm_drv_n2k_socketcan.cpp b/src/comm_drv_n2k_socketcan.cpp
index bcf4845..64b77e0 100644
--- a/src/comm_drv_n2k_socketcan.cpp
+++ b/src/comm_drv_n2k_socketcan.cpp
@@ -26,6 +26,7 @@
 #if !defined(__linux__) || defined(__ANDROID__)
 #error "This file can only be compiled on Linux"
 #endif
+#include "config.h"
 
 #include <algorithm>
 #include <atomic>
@@ -33,15 +34,19 @@
 #include <mutex>
 #include <thread>
 #include <vector>
-
 #include <linux/can.h>
 #include <linux/can/raw.h>
 #include <net/if.h>
-#include <serial/serial.h>
 #include <sys/ioctl.h>
 #include <sys/socket.h>
 #include <sys/time.h>
 
+#ifdef HAVE_SYS_SERIAL_LIB
+#include <serial.h>
+#elif !defined(__ANDROID__)
+#include "serial/serial.h"
+#endif
+
 #include <wx/log.h>
 #include <wx/string.h>
 #include <wx/utils.h>
diff --git a/src/ocpn_app.cpp b/src/ocpn_app.cpp
index 2e6c93b..a17fd25 100644
--- a/src/ocpn_app.cpp
+++ b/src/ocpn_app.cpp
@@ -24,7 +24,6 @@
  **************************************************************************/
 #include "config.h"
 
-
 #ifdef __MINGW32__
 #undef IPV6STRICT  // mingw FTBS fix:  missing struct ip_mreq
 #include <windows.h>
@@ -168,8 +167,10 @@ void RedirectIOToConsole();
 #include "crashprint.h"
 #endif
 
-#ifdef __OCPN__ANDROID__
+#ifdef __ANDROID__
 #include "androidUTIL.h"
+#elif defined(HAVE_SYS_SERIAL_LIB)
+#include <serial.h>
 #else
 #include "serial/serial.h"
 #endif
diff --git a/src/ser_ports.cpp b/src/ser_ports.cpp
index 665bc60..04c51fe 100644
--- a/src/ser_ports.cpp
+++ b/src/ser_ports.cpp
@@ -56,7 +56,9 @@
 #endif
 
 
-#ifdef OCPN_USE_NEWSERIAL
+#ifdef OCPN_USE_NEWSERIAL && defined(HAVE_SYS_SERIAL_LIB)
+#include <serial.h>
+#elif OCPN_USE_NEWSERIAL
 #include "serial/serial.h"
 #endif
 
